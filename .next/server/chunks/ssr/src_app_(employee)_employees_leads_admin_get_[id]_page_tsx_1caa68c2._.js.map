{"version":3,"sources":["turbopack:///[project]/src/app/(employee)/employees/leads/admin/get/[id]/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useRouter } from \"next/navigation\";\nimport useSWR from \"swr\";\nimport { useState, useRef, useEffect } from \"react\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowLeft } from \"lucide-react\";\nimport Link from \"next/link\";\n\ntype EmployeeMeta = {\n  employeeId?: string;\n  name?: string;\n  designation?: string | null;\n  department?: string | null;\n  profileUrl?: string | null;\n};\n\ntype Lead = {\n  id: number;\n  name?: string;\n  email?: string;\n  clientCategory?: string;\n  leadSource?: string;\n  leadOwner?: string;\n  addedBy?: string;\n  leadOwnerMeta?: EmployeeMeta;\n  addedByMeta?: EmployeeMeta;\n  createDeal?: boolean;\n  autoConvertToClient?: boolean;\n  companyName?: string;\n  mobileNumber?: string;\n  city?: string;\n  country?: string;\n  status?: string;\n  createdAt?: string;\n  updatedAt?: string;\n  notes?: unknown[];\n  deals?: unknown[];\n  officePhone?: string;\n  officialWebsite?: string;\n  postalCode?: string;\n  companyAddress?: string;\n};\n\ntype Followup = {\n  id: number;\n  nextDate?: string;\n  startTime?: string;\n  remarks?: string;\n  sendReminder?: boolean;\n  reminderSent?: boolean;\n  createdAt?: string;\n};\n\ntype Deal = {\n  id: number;\n  title?: string;\n  value?: number;\n  dealStage?: string;\n  dealAgent?: string;\n  dealWatchers?: string[];\n  leadId?: number;\n  leadName?: string;\n  leadMobile?: string;\n  leadCompanyName?: string;\n  pipeline?: string;\n  dealCategory?: string;\n  expectedCloseDate?: string | null;\n  createdAt?: string;\n  updatedAt?: string;\n  followups?: Followup[];\n  tags?: string[];\n  comments?: unknown[];\n  assignedEmployeesMeta?: EmployeeMeta[];\n  dealAgentMeta?: EmployeeMeta;\n  dealWatchersMeta?: EmployeeMeta[];\n};\n\ntype DealCategory = { id: number; categoryName: string };\n\ntype Note = {\n  id?: number;\n  noteTitle: string;\n  noteType: \"PUBLIC\" | \"PRIVATE\";\n  noteDetails?: string | null;\n  createdAt?: string;\n  updatedAt?: string;\n};\n\nconst BASE =  `${process.env.NEXT_PUBLIC_MAIN}`; // change if needed\nconst CREATE_URL = `${BASE}/deals`; // adjust if your create endpoint differs\nconst EMP_API = `${BASE}/employee/all?page=0&size=20`;\nconst CAT_API = `${BASE}/deals/dealCategory`;\n\nconst fetcher = async (url: string) => {\n  const accessToken = localStorage.getItem(\"accessToken\");\n  if (!accessToken) throw new Error(\"No access token found. Please log in.\");\n\n  const res = await fetch(url, {\n    cache: \"no-store\",\n    headers: {\n      Authorization: `Bearer ${accessToken}`,\n      Accept: \"application/json\",\n    },\n  });\n\n  if (!res.ok) {\n    let message = \"Failed to load data.\";\n    try {\n      const json = await res.json();\n      message = json?.message || json?.error || message;\n    } catch {\n      message = (await res.text()) || message;\n    }\n    throw new Error(message);\n  }\n  return res.json();\n};\n\nfunction fmt(v?: string | null) {\n  return v && v !== \"null\" ? v : \"--\";\n}\nfunction fmtDate(d?: string | null) {\n  return d ? new Date(d).toLocaleString() : \"--\";\n}\nfunction fmtShortDate(d?: string | null) {\n  return d ? new Date(d).toLocaleDateString() : \"--\";\n}\nfunction fmtCurrency(n?: number | null) {\n  if (n == null || isNaN(Number(n))) return \"--\";\n  return new Intl.NumberFormat(undefined, { style: \"currency\", currency: \"USD\", maximumFractionDigits: 0 }).format(n);\n}\n\n/* ---------------- DealViewModal (kept intact) ---------------- */\nfunction DealViewModal({ deal, lead, onClose }: { deal: Deal; lead?: Lead | null; onClose: () => void }) {\n  const [files, setFiles] = useState<{ name: string; url?: string }[]>([]);\n  const [uploading, setUploading] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [fileError, setFileError] = useState<string | null>(null);\n\n  useEffect(() => {\n    const loadFiles = async () => {\n      try {\n        const token = localStorage.getItem(\"accessToken\");\n        if (!token) return;\n        const res = await fetch(`${BASE}/deals/${deal.id}/files`, {\n          headers: { Authorization: `Bearer ${token}`, Accept: \"application/json\" },\n        });\n        if (!res.ok) return;\n        const json = await res.json();\n        if (Array.isArray(json)) setFiles(json);\n      } catch (err) {\n        // ignore silently\n      }\n    };\n    loadFiles();\n  }, [deal.id]);\n\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    setFileError(null);\n    const f = e.target.files?.[0] ?? null;\n    setSelectedFile(f);\n  };\n\n  const handleUpload = async () => {\n    if (!selectedFile) {\n      setFileError(\"Select a file first.\");\n      return;\n    }\n    setFileError(null);\n    setUploading(true);\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const fd = new FormData();\n      fd.append(\"file\", selectedFile);\n\n      const res = await fetch(`${BASE}/deals/${deal.id}/files`, {\n        method: \"POST\",\n        headers: { Authorization: `Bearer ${token}` },\n        body: fd,\n      });\n\n      if (!res.ok) throw new Error(await res.text());\n      const json = await res.json();\n      const uploaded = (json && (json.name || json.url)) ? { name: json.name || selectedFile.name, url: json.url } : { name: selectedFile.name };\n      setFiles((s) => [uploaded, ...s]);\n      setSelectedFile(null);\n      (document.getElementById(\"deal-file-input\") as HTMLInputElement | null)?.value && ((document.getElementById(\"deal-file-input\") as HTMLInputElement).value = \"\");\n    } catch (err: any) {\n      setFileError(err?.message ?? \"Upload failed.\");\n    } finally {\n      setUploading(false);\n    }\n  };\n  const leadCompanyName = lead?.companyName ?? \"\";\n  const leadEmail = lead?.email ?? \"\";\n  const leadPhone = lead?.mobileNumber ?? deal.leadMobile ?? \"\";\n\n  return (\n    <div className=\"fixed inset-0 z-50\">\n      <div className=\"absolute inset-0 bg-black/30\" onClick={onClose} />\n      <div className=\"fixed inset-0 flex items-start justify-center px-4 pt-8\">\n        <div className=\"max-w-5xl w-full bg-white rounded-lg shadow-lg border overflow-auto\" style={{ maxHeight: \"92vh\" }}>\n          <div className=\"flex items-center justify-between p-4 border-b\">\n            <h3 className=\"text-lg font-semibold\">Deal {deal.id ?? \"\"}</h3>\n            <button onClick={onClose} className=\"text-muted-foreground p-1 rounded hover:bg-slate-100\">\n              <svg className=\"w-6 h-6\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                <path strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          </div>\n\n          <div className=\"p-6 grid grid-cols-1 lg:grid-cols-3 gap-6\">\n            <div className=\"lg:col-span-2 rounded-lg border p-4\">\n              <h4 className=\"font-medium mb-2\">Deal Information </h4>\n              <div className=\"text-sm text-muted-foreground mb-4\">\n                {deal.pipeline ?? \"Default Pipeline\"} â†’ {deal.dealStage ?? \"--\"}\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\">\n                <div>\n                  <div className=\"text-xs text-muted-foreground\">Deal Name</div>\n                  <div className=\"font-medium\">{deal.title ?? `Deal ${deal.id}`}</div>\n                </div>\n\n                <div>\n                  <div className=\"text-xs text-muted-foreground\">Lead Contact</div>\n                  <div>{deal.leadName ?? \"--\"}</div>\n                </div>\n\n                <div>\n                  <div className=\"text-xs text-muted-foreground\">Email</div>\n                  <div>{leadEmail ? <a className=\"text-sky-600 underline\" href={`mailto:${leadEmail}`}>{leadEmail}</a> : \"--\"}</div>\n                </div>\n\n                <div>\n                  <div className=\"text-xs text-muted-foreground\">Company Name</div>\n                  <div>{leadCompanyName ?? \"--\"}</div>\n                </div>\n\n                <div>\n                  <div className=\"text-xs text-muted-foreground\">Deal Category</div>\n                  <div>{deal.dealCategory ?? \"--\"}</div>\n                </div>\n\n                <div>\n                  <div className=\"text-xs text-muted-foreground\">Deal Agent</div>\n                  <div>{deal.dealAgentMeta?.name ?? deal.dealAgent ?? \"--\"}</div>\n                </div>\n\n                <div>\n                  <div className=\"text-xs text-muted-foreground\">Deal Watcher</div>\n                  <div>{deal.dealWatchersMeta && deal.dealWatchersMeta.length ? deal.dealWatchersMeta[0].name : \"--\"}</div>\n                </div>\n\n                <div>\n                  <div className=\"text-xs text-muted-foreground\">Close Date</div>\n                  <div>{deal.expectedCloseDate ? fmtShortDate(deal.expectedCloseDate) : \"--\"}</div>\n                </div>\n\n                <div>\n                  <div className=\"text-xs text-muted-foreground\">Deal Value</div>\n                  <div>{fmtCurrency(deal.value ?? 0)}</div>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"rounded-lg border p-4\">\n              <h4 className=\"font-medium mb-3\">Lead Contact Details</h4>\n              <div className=\"text-sm grid gap-2\">\n                <div className=\"flex justify-between\">\n                  <div className=\"text-xs text-muted-foreground\">Name</div>\n                  <div>{deal.leadName ?? \"--\"}</div>\n                </div>\n\n                <div className=\"flex justify-between\">\n                  <div className=\"text-xs text-muted-foreground\">Email</div>\n                  <div>\n                    {leadEmail ? (\n                      <a className=\"text-sky-600 underline\" href={`mailto:${leadEmail}`} target=\"_blank\" rel=\"noreferrer\">\n                        {leadEmail}\n                      </a>\n                    ) : (\n                      \"--\"\n                    )}\n                  </div>\n                </div>\n\n                <div className=\"flex justify-between\">\n                  <div className=\"text-xs text-muted-foreground\">Mobile</div>\n                  <div>\n                    {leadPhone ? (\n                      <a className=\"text-sky-600 underline\" href={`tel:${leadPhone}`}>\n                        {leadPhone}\n                      </a>\n                    ) : (\n                      \"--\"\n                    )}\n                  </div>\n                </div>\n\n                <div className=\"flex justify-between\">\n                  <div className=\"text-xs text-muted-foreground\">Company Name</div>\n                  <div>{leadCompanyName ?? \"--\"}</div>\n                </div>\n\n                <div className=\"mt-3 flex gap-2\">\n                  <a href={leadEmail ? `mailto:${leadEmail}` : \"#\"} className=\"px-3 py-2 border rounded text-sm inline-flex items-center gap-2\" target=\"_blank\" rel=\"noreferrer\">\n                    <svg className=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                      <path strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M3 8l7.89 5.26a3 3 0 003.22 0L21 8\" />\n                    </svg>\n                    Email\n                  </a>\n                  <a href={leadPhone ? `tel:${leadPhone}` : \"#\"} className=\"px-3 py-2 border rounded text-sm inline-flex items-center gap-2\">\n                    <svg className=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                      <path strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M22 16.92V21a1 1 0 01-1.11 1A19.86 19.86 0 013 5.11 1 1 0 014 4h4.09a1 1 0 01.95.68 12.05 12.05 0 00.7 2.28 1 1 0 01-.24 1.02L8.91 10.9\" />\n                    </svg>\n                    Call\n                  </a>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"lg:col-span-3 mt-4 rounded-lg border p-4\">\n              <div className=\"flex gap-6 border-b pb-3 text-sm\">\n                <button className=\"pb-2 border-b-2 border-sky-600 text-sky-600 font-medium\">Files</button>\n                <button className=\"pb-2 border-b-2 border-transparent text-slate-700\">Follow Up</button>\n                <button className=\"pb-2 border-b-2 border-transparent text-slate-700\">People</button>\n                <button className=\"pb-2 border-b-2 border-transparent text-slate-700\">Notes</button>\n                <button className=\"pb-2 border-b-2 border-transparent text-slate-700\">Comments</button>\n                <button className=\"pb-2 border-b-2 border-transparent text-slate-700\">Tags</button>\n              </div>\n\n              <div className=\"mt-4 text-sm\">\n                <div className=\"mb-4\">\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Upload File</label>\n                  <div className=\"flex items-center gap-3\">\n                    <input id=\"deal-file-input\" type=\"file\" onChange={handleFileChange} className=\"text-sm\" />\n                    <button\n                      onClick={handleUpload}\n                      disabled={uploading}\n                      className={`px-3 py-2 rounded bg-blue-600 text-white ${uploading ? \"opacity-60\" : \"hover:bg-blue-700\"}`}\n                    >\n                      {uploading ? \"Uploading...\" : \"Upload\"}\n                    </button>\n                    {fileError && <div className=\"text-destructive text-xs\">{fileError}</div>}\n                  </div>\n                </div>\n\n                <div>\n                  <h5 className=\"text-sm font-medium mb-2\">Files</h5>\n                  {files.length === 0 ? (\n                    <div className=\"text-muted-foreground\">No files uploaded.</div>\n                  ) : (\n                    <ul className=\"list-disc pl-5 text-sm\">\n                      {files.map((f, i) => (\n                        <li key={i}>\n                          {f.url ? <a href={f.url} className=\"text-sky-600 underline\" target=\"_blank\" rel=\"noreferrer\">{f.name}</a> : f.name}\n                        </li>\n                      ))}\n                    </ul>\n                  )}\n                </div>\n\n                <div className=\"mt-4\">Follow ups / files listing area â€” replicate your existing UI here as needed.</div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n/* ---------------- DealCategoryModal (kept intact) ---------------- */\nfunction DealCategoryModal({ onClose, onSaved }: { onClose: () => void; onSaved: () => void }) {\n  const [categories, setCategories] = useState<DealCategory[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [newName, setNewName] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n\n  const load = async () => {\n    setLoading(true);\n    setError(null);\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const res = await fetch(CAT_API, { headers: { Authorization: `Bearer ${token}` } });\n      if (!res.ok) throw new Error(await res.text());\n      const json = await res.json();\n      setCategories(json);\n    } catch (err: any) {\n      setError(err?.message ?? \"Failed to load categories\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    load();\n  }, []);\n\n  const handleAdd = async () => {\n    if (!newName.trim()) {\n      setError(\"Category name required.\");\n      return;\n    }\n    setError(null);\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const res = await fetch(CAT_API, {\n        method: \"POST\",\n        headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ categoryName: newName }),\n      });\n      if (!res.ok) throw new Error(await res.text());\n      await load();\n      onSaved();\n    } catch (err: any) {\n      setError(err?.message ?? \"Failed to add category\");\n    }\n  };\n\n  const handleDelete = async (id: number) => {\n    if (!confirm(\"Delete this category?\")) return;\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const res = await fetch(`${CAT_API}/${id}`, {\n        method: \"DELETE\",\n        headers: { Authorization: `Bearer ${token}` },\n      });\n      if (!res.ok) throw new Error(await res.text());\n      await load();\n      onSaved();\n    } catch (err: any) {\n      alert(\"Error: \" + (err?.message ?? err));\n    }\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-50\">\n      <div className=\"absolute inset-0 bg-black/40\" onClick={onClose} />\n      <div className=\"fixed inset-0 flex items-start justify-center px-4 pt-12\">\n        <div className=\"max-w-3xl w-full bg-white rounded-lg shadow-lg border overflow-auto\" style={{ maxHeight: \"80vh\" }}>\n          <div className=\"flex items-center justify-between p-4 border-b\">\n            <h3 className=\"text-lg font-semibold\">Deal Category</h3>\n            <button onClick={onClose} className=\"text-muted-foreground p-1 rounded hover:bg-slate-100\">\n              <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                <path strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          </div>\n\n          <div className=\"p-6\">\n            {error && <div className=\"text-destructive mb-3\">{error}</div>}\n            <div className=\"rounded-lg border p-4 mb-4\">\n              <div className=\"overflow-auto\">\n                <table className=\"min-w-full text-sm\">\n                  <thead className=\"bg-sky-50 text-left\">\n                    <tr>\n                      <th className=\"px-4 py-2 w-12\">#</th>\n                      <th className=\"px-4 py-2\">Category Name</th>\n                      <th className=\"px-4 py-2 w-24\">Action</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {loading ? (\n                      <tr><td colSpan={3} className=\"px-4 py-4 text-center text-muted-foreground\">Loadingâ€¦</td></tr>\n                    ) : categories.length === 0 ? (\n                      <tr><td colSpan={3} className=\"px-4 py-4 text-center text-muted-foreground\">No categories.</td></tr>\n                    ) : (\n                      categories.map((c, idx) => (\n                        <tr key={c.id} className=\"border-t\">\n                          <td className=\"px-4 py-3\">{idx + 1}</td>\n                          <td className=\"px-4 py-3\">{c.categoryName}</td>\n                          <td className=\"px-4 py-3\">\n                            <button onClick={() => handleDelete(c.id)} className=\"text-destructive px-2 py-1 rounded border\">ðŸ—‘</button>\n                          </td>\n                        </tr>\n                      ))\n                    )}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n\n            <div className=\"mb-4\">\n              <label className=\"block text-sm text-muted-foreground mb-2\">Deal Category Name *</label>\n              <input value={newName} onChange={(e) => setNewName(e.target.value)} className=\"w-full p-2 border rounded-md\" />\n            </div>\n\n            <div className=\"flex items-center justify-center gap-6\">\n              <button onClick={onClose} className=\"px-6 py-2 border rounded-full text-blue-600 hover:bg-blue-50\">Cancel</button>\n              <button onClick={handleAdd} className=\"px-6 py-2 rounded-full text-white bg-blue-600 hover:bg-blue-700\">Save</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n/* ---------------- AddDealModal (kept intact) ---------------- */\nfunction AddDealModal({\n  lead,\n  onClose,\n  onCreated,\n  possibleAgents,\n  possibleWatchers,\n}: {\n  lead: Lead;\n  onClose: () => void;\n  onCreated: (d: Deal) => void;\n  possibleAgents: EmployeeMeta[];\n  possibleWatchers: EmployeeMeta[];\n}) {\n  const [form, setForm] = useState({\n    leadContact: lead?.id ?? \"\",\n    title: \"\",\n    pipeline: \"\",\n    dealStage: \"Qualified\",\n    dealCategory: \"\",\n    dealAgent: \"\",\n    dealWatchers: [] as string[],\n    value: \"\",\n    closeDate: \"\",\n  });\n\n  const [submitting, setSubmitting] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  const [watchersOpen, setWatchersOpen] = useState(false);\n  const watchersButtonRef = useRef<HTMLButtonElement | null>(null);\n  const [panelPos, setPanelPos] = useState<{ top: number; left: number; width: number } | null>(null);\n\n  const [categories, setCategories] = useState<DealCategory[]>([]);\n  const [catsLoading, setCatsLoading] = useState(true);\n  const [catModalOpen, setCatModalOpen] = useState(false);\n\n  const update = (k: keyof typeof form, v: any) => setForm((s) => ({ ...s, [k]: v }));\n\n  useEffect(() => {\n    const onKey = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") onClose();\n    };\n    document.addEventListener(\"keydown\", onKey);\n    return () => document.removeEventListener(\"keydown\", onKey);\n  }, [onClose]);\n\n  const loadCategories = async () => {\n    setCatsLoading(true);\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const res = await fetch(CAT_API, { headers: { Authorization: `Bearer ${token}` } });\n      if (!res.ok) throw new Error(await res.text());\n      const json: DealCategory[] = await res.json();\n      setCategories(json);\n      if (!form.dealCategory && json.length > 0) {\n        setForm((s) => ({ ...s, dealCategory: json[0].categoryName }));\n      }\n    } catch (err: any) {\n      console.error(\"Failed to load categories\", err);\n    } finally {\n      setCatsLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    loadCategories();\n  }, []);\n\n  const validate = () => {\n    if (!form.title.trim()) return \"Deal Name is required.\";\n    if (!form.pipeline.trim()) return \"Pipeline is required.\";\n    if (!form.dealStage.trim()) return \"Deal stage is required.\";\n    if (!form.closeDate.trim()) return \"Close date is required.\";\n    return null;\n  };\n\n  const toggleWatcher = (employeeId: string, checked: boolean) => {\n    setForm((s) => {\n      const curr = s.dealWatchers || [];\n      const updated = checked ? [...curr, employeeId] : curr.filter((id) => id !== employeeId);\n      return { ...s, dealWatchers: updated };\n    });\n  };\n\n  const submit = async (e?: React.FormEvent) => {\n    e?.preventDefault();\n    const v = validate();\n    if (v) {\n      setError(v);\n      return;\n    }\n    setError(null);\n    setSubmitting(true);\n\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n\n      const body: any = {\n        title: form.title,\n        pipeline: form.pipeline || undefined,\n        dealStage: form.dealStage || undefined,\n        dealCategory: form.dealCategory || undefined,\n        dealAgent: form.dealAgent || undefined,\n        dealWatchers: form.dealWatchers && form.dealWatchers.length ? form.dealWatchers : undefined,\n        value: form.value ? Number(form.value) : undefined,\n        closeDate: form.closeDate || undefined,\n        leadId: lead.id,\n      };\n\n      const res = await fetch(CREATE_URL, {\n        method: \"POST\",\n        headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      });\n\n      if (!res.ok) {\n        const txt = await res.text().catch(() => \"\");\n        throw new Error(txt || \"Failed to create deal.\");\n      }\n\n      const createdDeal = await res.json();\n      onCreated(createdDeal as Deal);\n      onClose();\n    } catch (err: any) {\n      setError(err?.message ?? \"Failed to create deal.\");\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  const openWatchers = () => {\n    const btn = watchersButtonRef.current;\n    if (!btn) {\n      setWatchersOpen(true);\n      return;\n    }\n    const rect = btn.getBoundingClientRect();\n    const top = rect.bottom + 8;\n    const left = rect.left;\n    const width = rect.width;\n    setPanelPos({ top, left, width });\n    setWatchersOpen((s) => !s);\n  };\n\n  const selectedWatcherNames = () => {\n    const selected = possibleWatchers.filter((w) => form.dealWatchers.includes(w.employeeId || \"\"));\n    if (selected.length === 0) return \"--\";\n    return selected.map((s) => s.name).join(\", \");\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-50\">\n      <div className=\"absolute inset-0 bg-black/30\" onClick={onClose} />\n      <div className=\"fixed inset-0 flex items-start justify-center px-4 pt-12\">\n        <div className=\"max-w-4xl w-full bg-white rounded-lg shadow-lg border overflow-auto\" style={{ maxHeight: \"92vh\" }}>\n          <div className=\"flex items-center justify-between p-4 border-b\">\n            <h3 className=\"text-lg font-semibold\">Add Deal Information</h3>\n            <button onClick={onClose} className=\"text-muted-foreground p-1 rounded hover:bg-slate-100\">\n              <svg className=\"w-6 h-6\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                <path strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          </div>\n\n          <form onSubmit={submit} className=\"p-6\">\n            {error && <div className=\"text-destructive text-sm mb-3\">{error}</div>}\n\n            <div className=\"rounded-lg border p-6\">\n              <h4 className=\"font-medium mb-4\">Deal Details</h4>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Lead Contact *</label>\n                  <select\n                    className=\"w-full p-2 border rounded-md bg-white text-sm\"\n                    value={String(form.leadContact)}\n                    onChange={(e) => update(\"leadContact\", Number(e.target.value))}\n                  >\n                    <option value=\"\">{lead?.name ?? \"--\"}</option>\n                  </select>\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Deal Name *</label>\n                  <input\n                    className=\"w-full p-2 border rounded-md text-sm\"\n                    value={form.title}\n                    onChange={(e) => update(\"title\", e.target.value)}\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Pipeline *</label>\n                  <select\n                    className=\"w-full p-2 border rounded-md bg-white text-sm\"\n                    value={form.pipeline}\n                    onChange={(e) => update(\"pipeline\", e.target.value)}\n                  >\n                    <option value=\"\">--</option>\n                    <option>Default Pipeline</option>\n                    <option>Sales</option>\n                  </select>\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Deal Stages *</label>\n                  <div className=\"relative\">\n                    <select\n                      className=\"w-full p-2 border rounded-md bg-white text-sm\"\n                      value={form.dealStage}\n                      onChange={(e) => update(\"dealStage\", e.target.value)}\n                    >\n                      <option>Qualified</option>\n                      <option>Generated</option>\n                      <option>Proposal</option>\n                      <option>Won</option>\n                      <option>Lost</option>\n                    </select>\n                    <div className=\"absolute left-3 top-3 w-2 h-2 rounded-full bg-sky-600\"></div>\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Deal Category</label>\n                  <div className=\"flex\">\n                    <select\n                      className=\"flex-1 p-2 border rounded-l-md bg-white text-sm\"\n                      value={form.dealCategory}\n                      onChange={(e) => update(\"dealCategory\", e.target.value)}\n                    >\n                      <option value=\"\">--</option>\n                      {!catsLoading && categories.map((c) => (\n                        <option key={c.id} value={c.categoryName}>{c.categoryName}</option>\n                      ))}\n                    </select>\n                    <button\n                      type=\"button\"\n                      onClick={() => setCatModalOpen(true)}\n                      className=\"px-3 py-2 border rounded-r-md bg-gray-200 text-sm\"\n                    >\n                      Add\n                    </button>\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Deal Agent</label>\n                  <select\n                    className=\"w-full p-2 border rounded-md bg-white text-sm\"\n                    value={form.dealAgent}\n                    onChange={(e) => update(\"dealAgent\", e.target.value)}\n                  >\n                    <option value=\"\">--</option>\n                    {possibleAgents.map((a) => (\n                      <option key={a.employeeId} value={a.employeeId}>{a.name}</option>\n                    ))}\n                  </select>\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Deal Value</label>\n                  <div className=\"flex items-stretch\">\n                    <span className=\"inline-flex items-center px-3 rounded-l-md border bg-slate-100 text-sm\">USD $</span>\n                    <input\n                      type=\"number\"\n                      className=\"w-full p-2 border rounded-r-md text-sm\"\n                      value={form.value}\n                      onChange={(e) => update(\"value\", e.target.value)}\n                    />\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Close Date *</label>\n                  <input\n                    type=\"date\"\n                    className=\"w-full p-2 border rounded-md text-sm\"\n                    value={form.closeDate}\n                    onChange={(e) => update(\"closeDate\", e.target.value)}\n                  />\n                </div>\n\n                <div className=\"relative\">\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Deal Watcher</label>\n\n                  <button\n                    type=\"button\"\n                    ref={watchersButtonRef}\n                    onClick={openWatchers}\n                    className=\"w-full p-2 border rounded-md text-left bg-white text-sm flex items-center justify-between\"\n                  >\n                    <span className=\"truncate\">{selectedWatcherNames()}</span>\n                    <svg className={`w-4 h-4 transform ${watchersOpen ? \"rotate-180\" : \"\"}`} viewBox=\"0 0 20 20\" fill=\"none\" stroke=\"currentColor\">\n                      <path d=\"M6 8l4 4 4-4\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" />\n                    </svg>\n                  </button>\n\n                  {watchersOpen && panelPos && (\n                    <div\n                      style={{\n                        position: \"fixed\",\n                        top: panelPos.top + window.scrollY,\n                        left: panelPos.left,\n                        width: panelPos.width,\n                        zIndex: 60,\n                      }}\n                    >\n                      <div className=\"bg-white border rounded-md shadow-lg p-3 max-h-[60vh] overflow-auto\">\n                        {possibleWatchers.length === 0 ? (\n                          <div className=\"text-sm text-muted-foreground\">No employees</div>\n                        ) : (\n                          <div className=\"grid gap-2\">\n                            {possibleWatchers.map((w) => (\n                              <label key={w.employeeId} className=\"flex items-start gap-2 text-sm\">\n                                <input\n                                  type=\"checkbox\"\n                                  className=\"mt-1\"\n                                  checked={form.dealWatchers.includes(w.employeeId || \"\")}\n                                  onChange={(e) => toggleWatcher(w.employeeId || \"\", e.target.checked)}\n                                />\n                                <div>\n                                  <div className=\"text-sm\">{w.name}</div>\n                                  {w.designation && <div className=\"text-xs text-muted-foreground\">{w.designation}</div>}\n                                </div>\n                              </label>\n                            ))}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  )}\n\n                  <div className=\"text-xs text-muted-foreground mt-1\">Click to open and select watchers</div>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"mt-6 flex items-center justify-center gap-6\">\n              <button\n                type=\"button\"\n                onClick={onClose}\n                className=\"px-6 py-2 border rounded-full text-blue-600 hover:bg-blue-50\"\n                disabled={submitting}\n              >\n                Cancel\n              </button>\n\n              <button\n                type=\"submit\"\n                disabled={submitting}\n                className={`px-6 py-2 rounded-full text-white ${submitting ? \"bg-blue-400 cursor-not-allowed\" : \"bg-blue-600 hover:bg-blue-700\"}`}\n              >\n                {submitting ? \"Creating...\" : \"Create\"}\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n\n      {catModalOpen && (\n        <DealCategoryModal\n          onClose={() => { setCatModalOpen(false); }}\n          onSaved={() => { loadCategories(); }}\n        />\n      )}\n    </div>\n  );\n}\n\n/* ---------------- EditModal (kept intact) ---------------- */\nfunction EditModal({ lead, onClose, onSaved }: { lead: Lead; onClose: () => void; onSaved: () => void }) {\n  const [form, setForm] = useState({\n    name: lead?.name ?? \"\",\n    email: lead?.email ?? \"\",\n    clientCategory: lead?.clientCategory ?? \"\",\n    leadSource: lead?.leadSource ?? \"\",\n    leadOwner: lead?.leadOwner ?? \"\",\n    addedBy: lead?.addedBy ?? \"\",\n    autoConvertToClient: !!lead?.autoConvertToClient,\n    companyName: lead?.companyName ?? \"\",\n    officialWebsite: lead?.officialWebsite ?? \"\",\n    mobileNumber: String(lead?.mobileNumber ?? \"\"),\n    officePhone: lead?.officePhone ?? \"\",\n    city: lead?.city ?? \"\",\n    state: lead?.state ?? \"\",\n    postalCode: lead?.postalCode ?? \"\",\n    country: lead?.country ?? \"\",\n    companyAddress: lead?.companyAddress ?? \"\",\n  });\n\n  const [submitting, setSubmitting] = useState(false);\n  const [errorMsg, setErrorMsg] = useState<string | null>(null);\n\n  useEffect(() => {\n    const onKey = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") onClose();\n    };\n    document.addEventListener(\"keydown\", onKey);\n    return () => document.removeEventListener(\"keydown\", onKey);\n  }, [onClose]);\n\n  const update = (k: keyof typeof form, v: any) => setForm((s) => ({ ...s, [k]: v }));\n\n  const validate = () => {\n    if (!form.name.trim() || !form.email.trim()) return \"Name and Email are required.\";\n    return null;\n  };\n\n  const submit = async (e?: React.FormEvent) => {\n    e?.preventDefault();\n    const v = validate();\n    if (v) {\n      setErrorMsg(v);\n      return;\n    }\n    setErrorMsg(null);\n    setSubmitting(true);\n\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n\n      const body: any = {\n        name: form.name,\n        email: form.email,\n        clientCategory: form.clientCategory || undefined,\n        leadSource: form.leadSource || undefined,\n        leadOwner: form.leadOwner || undefined,\n        addedBy: form.addedBy || undefined,\n        autoConvertToClient: !!form.autoConvertToClient,\n        companyName: form.companyName || undefined,\n        officialWebsite: form.officialWebsite || undefined,\n        mobileNumber: form.mobileNumber ? Number(form.mobileNumber) : undefined,\n        officePhone: form.officePhone || undefined,\n        city: form.city || undefined,\n        state: form.state || undefined,\n        postalCode: form.postalCode || undefined,\n        country: form.country || undefined,\n        companyAddress: form.companyAddress || undefined,\n      };\n\n      const res = await fetch(`${BASE}/leads/${lead.id}`, {\n        method: \"PUT\",\n        headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      });\n\n      if (!res.ok) {\n        const txt = await res.text().catch(() => \"\");\n        throw new Error(txt || \"Update failed\");\n      }\n\n      await res.json();\n      alert(\"Lead updated successfully.\");\n      await onSaved();\n    } catch (err: any) {\n      setErrorMsg(err?.message ?? \"Failed to update lead.\");\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-50\">\n      <div className=\"absolute inset-0 bg-black/30\" onClick={onClose} />\n\n      <div className=\"fixed inset-0 flex items-start justify-center px-4 pt-12\">\n        <div className=\"max-w-4xl w-full bg-white rounded-lg shadow-lg border overflow-auto\" style={{ maxHeight: \"92vh\" }}>\n          <div className=\"flex items-center justify-between p-4 border-b\">\n            <h3 className=\"text-lg font-semibold\">Update Lead Contact</h3>\n            <button onClick={onClose} className=\"text-muted-foreground p-1 rounded hover:bg-slate-100\">\n              <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                <path strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          </div>\n\n          <form onSubmit={submit} className=\"p-6 space-y-6\">\n            {errorMsg && <div className=\"text-destructive text-sm\">{errorMsg}</div>}\n\n            <div className=\"rounded-lg border p-4\">\n              <h4 className=\"font-medium mb-3\">Contact Details</h4>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Name *</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.name} onChange={(e) => update(\"name\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Email *</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.email} onChange={(e) => update(\"email\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Lead Source</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.leadSource} onChange={(e) => update(\"leadSource\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Lead Owner</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.leadOwner} onChange={(e) => update(\"leadOwner\", e.target.value)} />\n                </div>\n\n                <div className=\"flex items-center gap-2 md:col-span-2\">\n                  <input type=\"checkbox\" id=\"autoConvert\" checked={!!form.autoConvertToClient} onChange={(e) => update(\"autoConvertToClient\", e.target.checked)} />\n                  <label htmlFor=\"autoConvert\" className=\"text-sm\">Auto Convert lead to client when the deal stage is set to \"WIN\".</label>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"rounded-lg border p-4\">\n              <h4 className=\"font-medium mb-3\">Company Details</h4>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Company Name</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.companyName} onChange={(e) => update(\"companyName\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Official Website</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.officialWebsite} onChange={(e) => update(\"officialWebsite\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Mobile Number</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.mobileNumber} onChange={(e) => update(\"mobileNumber\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Office Phone No.</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.officePhone} onChange={(e) => update(\"officePhone\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">City</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.city} onChange={(e) => update(\"city\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">State</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.state} onChange={(e) => update(\"state\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Postal Code</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.postalCode} onChange={(e) => update(\"postalCode\", e.target.value)} />\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground\">Country</label>\n                  <input className=\"w-full border rounded-md p-2\" value={form.country} onChange={(e) => update(\"country\", e.target.value)} />\n                </div>\n\n                <div className=\"md:col-span-3\">\n                  <label className=\"text-sm text-muted-foreground\">Company Address</label>\n                  <textarea className=\"w-full border rounded-md p-2 h-28\" value={form.companyAddress} onChange={(e) => update(\"companyAddress\", e.target.value)} />\n                </div>\n              </div>\n            </div>\n\n            <div className=\"flex justify-end gap-3\">\n              <Button variant=\"outline\" onClick={onClose} disabled={submitting}>Cancel</Button>\n              <Button type=\"submit\" onClick={submit} disabled={submitting}>{submitting ? \"Updating...\" : \"Update\"}</Button>\n            </div>\n          </form>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n/* ---------------- Add/Edit Note Modal (kept intact) ---------------- */\nfunction AddEditNoteModal({\n  leadId,\n  initial,\n  onClose,\n  onSaved,\n}: {\n  leadId: number;\n  initial?: Note | null;\n  onClose: () => void;\n  onSaved: (note?: Note) => void;\n}) {\n  const isEdit = !!initial?.id;\n  const [form, setForm] = useState<Note>({\n    noteTitle: initial?.noteTitle ?? \"\",\n    noteType: (initial?.noteType as \"PUBLIC\" | \"PRIVATE\") ?? \"PUBLIC\",\n    noteDetails: initial?.noteDetails ?? \"\",\n  });\n  const [submitting, setSubmitting] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    const onKey = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") onClose();\n    };\n    document.addEventListener(\"keydown\", onKey);\n    return () => document.removeEventListener(\"keydown\", onKey);\n  }, [onClose]);\n\n  const update = (k: keyof Note, v: any) => setForm((s) => ({ ...s, [k]: v }));\n\n  const validate = () => {\n    if (!form.noteTitle.trim()) return \"Note Title is required.\";\n    return null;\n  };\n\n  const submit = async (e?: React.FormEvent) => {\n    e?.preventDefault();\n    const v = validate();\n    if (v) {\n      setError(v);\n      return;\n    }\n    setError(null);\n    setSubmitting(true);\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const url = isEdit\n        ? `${BASE}/leads/${leadId}/notes/${initial?.id}`\n        : `${BASE}/leads/${leadId}/notes`;\n      const method = isEdit ? \"PUT\" : \"POST\";\n      const res = await fetch(url, {\n        method,\n        headers: { Authorization: `Bearer ${token}`, \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          noteTitle: form.noteTitle,\n          noteType: form.noteType,\n          noteDetails: form.noteDetails,\n        }),\n      });\n      if (!res.ok) {\n        const txt = await res.text().catch(() => \"\");\n        throw new Error(txt || \"Failed to save note.\");\n      }\n      const saved = await res.json();\n      onSaved(saved);\n    } catch (err: any) {\n      setError(err?.message ?? \"Save failed\");\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  return (\n    <div className=\"fixed inset-0 z-50\">\n      <div className=\"absolute inset-0 bg-black/30\" onClick={onClose} />\n      <div className=\"fixed inset-0 flex items-start justify-center px-4 pt-12\">\n        <div className=\"max-w-3xl w-full bg-white rounded-lg shadow-lg border overflow-auto\" style={{ maxHeight: \"90vh\" }}>\n          <div className=\"flex items-center justify-between p-4 border-b\">\n            <h3 className=\"text-lg font-semibold\">{isEdit ? \"Edit Lead Note\" : \"Add Lead Note\"}</h3>\n            <button onClick={onClose} className=\"text-muted-foreground p-1 rounded hover:bg-slate-100\">\n              <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                <path strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          </div>\n\n          <form onSubmit={submit} className=\"p-6\">\n            {error && <div className=\"text-destructive text-sm mb-3\">{error}</div>}\n            <div className=\"rounded-lg border p-6\">\n              <h4 className=\"font-medium mb-4\">Lead Note Details</h4>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Note Title *</label>\n                  <input\n                    className=\"w-full p-2 border rounded-md text-sm\"\n                    value={form.noteTitle}\n                    onChange={(e) => update(\"noteTitle\", e.target.value)}\n                    placeholder=\"Enter Note Title\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Note Type</label>\n                  <div className=\"flex items-center gap-4 mt-2\">\n                    <label className=\"flex items-center gap-2 text-sm\">\n                      <input type=\"radio\" checked={form.noteType === \"PUBLIC\"} onChange={() => update(\"noteType\", \"PUBLIC\")} />\n                      <span>Public</span>\n                    </label>\n                    <label className=\"flex items-center gap-2 text-sm\">\n                      <input type=\"radio\" checked={form.noteType === \"PRIVATE\"} onChange={() => update(\"noteType\", \"PRIVATE\")} />\n                      <span>Private</span>\n                    </label>\n                  </div>\n                </div>\n\n                <div className=\"md:col-span-2\">\n                  <label className=\"block text-xs text-muted-foreground mb-2\">Note Detail</label>\n                  <textarea\n                    className=\"w-full p-3 border rounded-md text-sm h-36\"\n                    value={form.noteDetails}\n                    onChange={(e) => update(\"noteDetails\", e.target.value)}\n                    placeholder=\"Enter details...\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            <div className=\"mt-6 flex items-center justify-center gap-6\">\n              <button type=\"button\" onClick={onClose} className=\"px-6 py-2 border rounded-full text-blue-600 hover:bg-blue-50\" disabled={submitting}>\n                Cancel\n              </button>\n\n              <button type=\"submit\" disabled={submitting} className={`px-6 py-2 rounded-full text-white ${submitting ? \"bg-blue-400\" : \"bg-blue-600 hover:bg-blue-700\"}`}>\n                {submitting ? \"Saving...\" : \"Save\"}\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n/* ---------------- NEW: ViewNoteModal (keeps same UI) ---------------- */\nfunction ViewNoteModal({ note, onClose }: { note: Note; onClose: () => void }) {\n  return (\n    <div className=\"fixed inset-0 z-50\">\n      <div className=\"absolute inset-0 bg-black/30\" onClick={onClose} />\n      <div className=\"fixed inset-0 flex items-start justify-center px-4 pt-12\">\n        <div className=\"max-w-3xl w-full bg-white rounded-lg shadow-lg border overflow-auto\" style={{ maxHeight: \"90vh\" }}>\n          <div className=\"flex items-center justify-between p-4 border-b\">\n            <h3 className=\"text-lg font-semibold\">{note.noteTitle ?? \"My Note\"}</h3>\n            <button onClick={onClose} className=\"text-muted-foreground p-1 rounded hover:bg-slate-100\">\n              <svg className=\"w-5 h-5\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\">\n                <path strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          </div>\n\n          <div className=\"p-6\">\n            <div className=\"rounded-lg border p-6\">\n              <h4 className=\"font-medium mb-4\">Project Note Details</h4>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm\">\n                <div className=\"text-muted-foreground\">Note Title</div>\n                <div className=\"md:col-span-2\">{note.noteTitle ?? \"--\"}</div>\n\n                <div className=\"text-muted-foreground\">Note Type</div>\n                <div className=\"md:col-span-2\">{note.noteType === \"PUBLIC\" ? \"Public\" : \"Private\"}</div>\n\n                <div className=\"text-muted-foreground\">Note Detail</div>\n                <div className=\"md:col-span-2\">{note.noteDetails ? note.noteDetails : \"---\"}</div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n/* ---------------- Main Page Component (updated: notes popup fixed positioning) ---------------- */\n\nexport default function LeadDetailPage({ params }: { params: { id: string } }) {\n  const router = useRouter();\n  const { data, error, isLoading, mutate } = useSWR<Lead>(`/api/leads/admin/get/${params.id}`, fetcher, {\n    refreshInterval: 30000,\n    revalidateOnFocus: true,\n  });\n\n  const [activeTab, setActiveTab] = useState<\"profile\" | \"deals\" | \"notes\">(\"profile\");\n  const [menuOpen, setMenuOpen] = useState(false);\n  const menuRef = useRef<HTMLDivElement | null>(null);\n\n  const [editOpen, setEditOpen] = useState(false);\n\n  const { data: dealsData, error: dealsError, isLoading: dealsLoading, mutate: mutateDeals } = useSWR<Deal[]>(\n    activeTab === \"deals\" ? `${BASE}/deals/lead/${params.id}` : null,\n    fetcher,\n    { refreshInterval: 30000, revalidateOnFocus: true }\n  );\n\n  const { data: empResp } = useSWR(EMP_API, fetcher, { refreshInterval: 0 });\n  const employees: EmployeeMeta[] = (empResp && Array.isArray(empResp.content) ? empResp.content.map((e: any) => ({\n    employeeId: e.employeeId,\n    name: e.name,\n    designation: e.designationName ?? null,\n    department: e.departmentName ?? null,\n    profileUrl: e.profilePictureUrl ?? null,\n  })) : []);\n\n  const [addDealOpen, setAddDealOpen] = useState(false);\n\n  // NEW: pass lead to view modal\n  const [viewDeal, setViewDeal] = useState<Deal | null>(null);\n  const [viewLead, setViewLead] = useState<Lead | null>(null);\n\n  useEffect(() => {\n    const onDoc = (e: MouseEvent) => {\n      if (!menuRef.current) return;\n      const t = e.target as Node;\n      if (menuOpen && !menuRef.current.contains(t)) setMenuOpen(false);\n    };\n    document.addEventListener(\"mousedown\", onDoc);\n    return () => document.removeEventListener(\"mousedown\", onDoc);\n  }, [menuOpen]);\n\n  const goEdit = () => {\n    setMenuOpen(false);\n    router.push(`/leads/admin/edit/${params.id}`);\n  };\n\n  // const handleMove = () => {\n  // setMenuOpen(false);\n  //   router.push(`/clients/new`);\n  // };\n\n\n  const convertToClient = async () => {\n    setMenuOpen(false);\n    //router.push(`/clients/new`);\n    if (!confirm(\"Convert this lead to client?\")) return;\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const res = await fetch(`${BASE}/leads/${params.id}/convert`, {\n        method: \"POST\",\n        headers: { Authorization: `Bearer ${token}` },\n      });\n      if (!res.ok) throw new Error(await res.text());\n      alert(\"Converted to client.\");\n      await mutate();\n      router.push(\"/leads\");\n    } catch (err: any) {\n      alert(\"Error: \" + (err?.message ?? err));\n    }\n  };\n\n  const remove = async () => {\n    setMenuOpen(false);\n    if (!confirm(\"Delete this lead?\")) return;\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const res = await fetch(`${BASE}/leads/${params.id}`, {\n        method: \"DELETE\",\n        headers: { Authorization: `Bearer ${token}` },\n      });\n      if (!res.ok) throw new Error(await res.text());\n      alert(\"Deleted.\");\n      router.push(\"/leads\");\n    } catch (err: any) {\n      alert(\"Error: \" + (err?.message ?? err));\n    }\n  };\n\n  const handleCreatedDeal = async (created: Deal) => {\n    if (mutateDeals) {\n      mutateDeals((curr: Deal[] | undefined) => (curr ? [created, ...curr] : [created]), false);\n    }\n  };\n\n  const agents = employees;\n  const watchers = employees;\n\n  /* ---------------- Notes state & functions ---------------- */\n  const [notes, setNotes] = useState<Note[]>([]);\n  const [notesLoading, setNotesLoading] = useState(false);\n  const [notesError, setNotesError] = useState<string | null>(null);\n  const [noteModalOpen, setNoteModalOpen] = useState(false);\n  const [editNote, setEditNote] = useState<Note | null>(null);\n\n  // openNoteMenuId stays the id; menuPos holds fixed coordinates for popup\n  const [openNoteMenuId, setOpenNoteMenuId] = useState<number | null>(null);\n  const [noteMenuPos, setNoteMenuPos] = useState<{ top: number; left: number } | null>(null);\n  const menuContainerRef = useRef<HTMLDivElement | null>(null);\n\n  const [viewNote, setViewNote] = useState<Note | null>(null); // for view modal\n\n  const NOTES_API = (leadId: string | number) => `${BASE}/leads/${leadId}/notes`;\n\n  const loadNotes = async () => {\n    setNotesLoading(true);\n    setNotesError(null);\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const res = await fetch(NOTES_API(params.id), { headers: { Authorization: `Bearer ${token}` } });\n      if (!res.ok) throw new Error(await res.text());\n      const json = await res.json();\n      setNotes(Array.isArray(json) ? json : []);\n    } catch (err: any) {\n      setNotesError(err?.message ?? \"Failed to load notes\");\n    } finally {\n      setNotesLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    if (activeTab === \"notes\") {\n      loadNotes();\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [activeTab, params.id]);\n\n  const openAddNote = () => {\n    setEditNote(null);\n    setNoteModalOpen(true);\n  };\n\n  const handleNoteSaved = (saved?: Note) => {\n    setNoteModalOpen(false);\n    setEditNote(null);\n    setOpenNoteMenuId(null);\n    if (saved) {\n      loadNotes();\n    } else {\n      loadNotes();\n    }\n  };\n\n  const handleDeleteNote = async (noteId?: number) => {\n    if (!noteId) return;\n    if (!confirm(\"Delete this note?\")) return;\n    try {\n      const token = localStorage.getItem(\"accessToken\");\n      if (!token) throw new Error(\"No access token.\");\n      const res = await fetch(`${NOTES_API(params.id)}/${noteId}`, {\n        method: \"DELETE\",\n        headers: { Authorization: `Bearer ${token}` },\n      });\n      if (!res.ok) throw new Error(await res.text());\n      setNotes((s) => s.filter((n) => n.id !== noteId));\n      setOpenNoteMenuId(null);\n      setNoteMenuPos(null);\n    } catch (err: any) {\n      alert(\"Error: \" + (err?.message ?? err));\n    }\n  };\n\n  // open fixed menu popup near button\n  const onOpenNoteMenu = (e: React.MouseEvent, noteId?: number) => {\n    e.stopPropagation();\n    if (!noteId) return;\n    const btn = e.currentTarget as HTMLElement;\n    const rect = btn.getBoundingClientRect();\n    // compute top/left for fixed positioned popup\n    const top = rect.bottom + 8 + window.scrollY; // include scrollY to position correctly\n    const left = rect.right - 160; // align right edge of popup near button (popup width ~ 160)\n    setOpenNoteMenuId((prev) => (prev === noteId ? null : noteId));\n    setNoteMenuPos({ top, left: Math.max(left, 8) });\n  };\n\n  // close popup on outside click / scroll / resize\n  useEffect(() => {\n    if (openNoteMenuId == null) return;\n    const onDocClick = (ev: MouseEvent) => {\n      const t = ev.target as Node;\n      if (!menuContainerRef.current) return;\n      if (!menuContainerRef.current.contains(t)) {\n        setOpenNoteMenuId(null);\n        setNoteMenuPos(null);\n      }\n    };\n    const onScroll = () => {\n      setOpenNoteMenuId(null);\n      setNoteMenuPos(null);\n    };\n    const onResize = () => {\n      setOpenNoteMenuId(null);\n      setNoteMenuPos(null);\n    };\n    document.addEventListener(\"mousedown\", onDocClick);\n    window.addEventListener(\"scroll\", onScroll, true);\n    window.addEventListener(\"resize\", onResize);\n    return () => {\n      document.removeEventListener(\"mousedown\", onDocClick);\n      window.removeEventListener(\"scroll\", onScroll, true);\n      window.removeEventListener(\"resize\", onResize);\n    };\n  }, [openNoteMenuId]);\n\n  return (\n    <main className=\"min-h-screen bg-gray-50\">\n      <div className=\"container mx-auto max-w-6xl px-4 py-8\">\n        {/* Header */}\n        <div className=\"flex items-center gap-4 mb-4\">\n          <Button variant=\"ghost\" size=\"icon\" onClick={() => router.back()} aria-label=\"Back\">\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <div>\n            <h1 className=\"text-2xl md:text-3xl font-semibold\">{data?.name ?? \"â€”\"}</h1>\n            <p className=\"text-sm text-muted-foreground mt-1\">Detailed information about the selected lead.</p>\n          </div>\n        </div>\n\n        {/* Tabs */}\n        {/* <div className=\"mb-4 border-b bg-white rounded-t\">\n          <nav className=\"flex items-center gap-6 px-4\">\n            <button\n              onClick={() => setActiveTab(\"profile\")}\n              className={`py-3 text-sm ${activeTab === \"profile\" ? \"border-b-2 border-sky-600 text-sky-600\" : \"text-muted-foreground\"}`}\n            >\n              Profile\n            </button>\n            <button\n              onClick={() => setActiveTab(\"deals\")}\n              className={`py-3 text-sm ${activeTab === \"deals\" ? \"border-b-2 border-sky-600 text-sky-600\" : \"text-muted-foreground\"}`}\n            >\n              Deals\n            </button>\n            <button\n              onClick={() => setActiveTab(\"notes\")}\n              className={`py-3 text-sm ${activeTab === \"notes\" ? \"border-b-2 border-sky-600 text-sky-600\" : \"text-muted-foreground\"}`}\n            >\n              Notes\n            </button>\n          </nav>\n        </div> */}\n\n        {/* Card */}\n        <Card className=\"p-6\">\n          {isLoading ? (\n            <div className=\"py-12 text-center text-muted-foreground\">Loading lead detailsâ€¦</div>\n          ) : error ? (\n            <div className=\"py-12 text-center\">\n              <p className=\"text-destructive\">Failed to load lead details.</p>\n              <p className=\"text-sm text-muted-foreground mt-2\">{(error as Error)?.message}</p>\n              <div className=\"mt-4\">\n                <Button variant=\"ghost\" onClick={() => router.back()}>\n                  Back to Leads\n                </Button>\n              </div>\n            </div>\n          ) : !data ? (\n            <div className=\"py-12 text-center text-muted-foreground\">No lead found.</div>\n          ) : (\n            <div>\n              <div className=\"flex items-start justify-between mb-6\">\n                <h3 className=\"text-lg font-semibold\">{activeTab === \"profile\" ? \"Profile Information\" : activeTab === \"deals\" ? \"Deals\" : \"Notes\"}</h3>\n\n                {/* <div className=\"relative\" ref={menuRef}>\n                  <button\n                    onClick={() => setMenuOpen((s) => !s)}\n                    className=\"p-2 rounded hover:bg-slate-100\"\n                    aria-label=\"More actions\"\n                  >\n                    <svg className=\"w-5 h-5 text-muted-foreground\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                      <circle cx=\"5\" cy=\"12\" r=\"1.5\" />\n                      <circle cx=\"12\" cy=\"12\" r=\"1.5\" />\n                      <circle cx=\"19\" cy=\"12\" r=\"1.5\" />\n                    </svg>\n                  </button>\n\n                \n                </div> */}\n              </div>\n\n              {/* PROFILE TAB */}\n              {/* {activeTab === \"profile\" && ( */}\n                <>\n                  <div className=\"rounded-lg border p-4\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                      <dl className=\"hidden md:block md:col-span-1 space-y-4 text-sm text-muted-foreground\">\n                        <dt>Name</dt>\n                        <dt>Email</dt>\n                        <dt>Lead Owner</dt>\n                        <dt>Source</dt>\n                        <dt>Company Name</dt>\n                        <dt>Website</dt>\n                        <dt>Mobile</dt>\n                        <dt>Office Phone Number</dt>\n                        <dt>City</dt>\n                        <dt>State</dt>\n                        <dt>Country</dt>\n                        <dt>Postal Code</dt>\n                        <dt>Address</dt>\n                      </dl>\n\n                      <div className=\"md:col-span-2\">\n                        <div className=\"grid gap-y-3\">\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Name</div>\n                            <div className=\"text-sm\">{fmt(data?.name)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Email</div>\n                            <div className=\"text-sm\">{fmt(data?.email)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Lead Owner</div>\n                            <div className=\"text-sm\">{data?.leadOwnerMeta?.name ?? data?.leadOwner ?? \"--\"}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Source</div>\n                            <div className=\"text-sm\">{fmt(data?.leadSource)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Company Name</div>\n                            <div className=\"text-sm\">{fmt(data?.companyName)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Website</div>\n                            <div className=\"text-sm\">{fmt((data as any)?.officialWebsite)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Mobile</div>\n                            <div className=\"text-sm\">{fmt(data?.mobileNumber)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Office Phone Number</div>\n                            <div className=\"text-sm\">{fmt(data?.officePhone)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">City</div>\n                            <div className=\"text-sm\">{fmt(data?.city)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">State</div>\n                            <div className=\"text-sm\">{fmt(data?.state)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Country</div>\n                            <div className=\"text-sm\">{fmt(data?.country)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Postal Code</div>\n                            <div className=\"text-sm\">{fmt(data?.postalCode)}</div>\n                          </div>\n\n                          <div className=\"flex items-start gap-6\">\n                            <div className=\"w-48 md:hidden text-sm text-muted-foreground\">Address</div>\n                            <div className=\"text-sm\">{fmt(data?.companyAddress)}</div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"mt-6 text-sm text-muted-foreground grid md:grid-cols-2 gap-2\">\n                    <div>Created: {fmtDate(data?.createdAt)}</div>\n                    <div className=\"text-right\">\n                      Status: <Badge variant=\"secondary\">{data?.status ?? \"--\"}</Badge>\n                    </div>\n                  </div>\n                </>\n              {/* )} */}\n\n              {/* DEALS TAB (kept intact) */}\n             \n\n              {/* NOTES TAB (updated: popup fixed positioning with no scroll lag) */}\n           \n            </div>\n          )}\n        </Card>\n      </div>\n\n      {/* Edit Modal */}\n      {/* {editOpen && data && (\n        <EditModal\n          lead={data}\n          onClose={() => setEditOpen(false)}\n          onSaved={async () => {\n            setEditOpen(false);\n            await mutate();\n          }}\n        />\n      )} */}\n\n      {/* Add Deal Modal */}\n      {/* {addDealOpen && data && (\n        <AddDealModal\n          lead={data}\n          onClose={() => setAddDealOpen(false)}\n          onCreated={handleCreatedDeal}\n          possibleAgents={agents}\n          possibleWatchers={watchers}\n        />\n      )} */}\n\n      {/* Deal View Modal\n      {viewDeal && (\n        <DealViewModal\n          deal={viewDeal}\n          lead={viewLead}\n          onClose={() => {\n            setViewDeal(null);\n            setViewLead(null);\n          }}\n        />\n      )} */}\n\n      {/* Notes Add/Edit Modal */}\n      {/* {noteModalOpen && data && (\n        <AddEditNoteModal\n          leadId={data.id}\n          initial={editNote}\n          onClose={() => {\n            setNoteModalOpen(false);\n            setEditNote(null);\n          }}\n          onSaved={(saved?: Note) => {\n            handleNoteSaved(saved);\n          }}\n        />\n      )} */}\n\n      {/* Notes View Modal */}\n      {/* {viewNote && (\n        <ViewNoteModal\n          note={viewNote}\n          onClose={() => {\n            setViewNote(null);\n          }}\n        />\n      )} */}\n    </main>\n  );\n}\n\n\n\n\n\n\n\n"],"names":[],"mappings":"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"}